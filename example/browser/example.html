<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>

    <title>Barchart Alert Client API</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
    <link rel="stylesheet" href="example.css" type="text/css">

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.0/lodash.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script src="../../dist/barchart-alerts-api.js"></script>

    <script type="text/javascript">
        'use strict';

        //var system = 'grains.com';
        //var userId = '108265';

        var system = 'barchart.com';
        var userId = 'barchart-test-user';

        //var alertManager = new Barchart.Alerts.AlertManager();

        var alertManager = new Barchart.Alerts.AlertManager('alerts-management-stage.barchart.com', 80, 'rest');
        //var alertManager = new Barchart.Alerts.AlertManager('localhost', 3000, 'rest');
        //var alertManager = new Barchart.Alerts.AlertManager('alerts-management-stage.barchart.com');
        //var alertManager = new Barchart.Alerts.AlertManager('localhost', 3000);

        var utilities = Barchart.Alerts.AlertManager;

        var targets = ko.observable();
        var properties = ko.observable();
        var operators = ko.observable();
        var publisherTypes = ko.observable();
        var marketDataConfiguration = ko.observable();

        function PageModel() {
            var that = this;

            that.version = ko.observable({ });

            that.alert = ko.observable();
            that.alerts = ko.observableArray([ ]);
            that.publisherSettings = ko.observable();
            that.marketDataSettings = ko.observable();
            that.activeTemplate = ko.observable('alert-grid-template');
            that.providerDescription = ko.observable(alertManager.toString());

            var getModel = function(alert) {
                return _.find(that.alerts(), function(model) {
                    return model.alert().alert_id === alert.alert_id;
                });
            };
            var sortModels = function() {
                that.alerts.sort(function(a, b) {
                    return a.alert().name.localeCompare(b.alert().name);
                });
            };

            that.changeToGrid = function() {
                that.alerts([ ]);

                that.activeTemplate('alert-grid-template');

                alertManager.retrieveAlerts({ user_id: userId, alert_system: system })
                    .then(function(alerts) {
                        that.alerts([ ]);

                        _.forEach(alerts, function(alert) {
                            that.alerts.push(new AlertDisplayModel(alert));
                        });

                        sortModels();
                    });
            };
            that.changeToCreate = function() {
                that.alert = new AlertEntryModel();

                that.activeTemplate('alert-entry-template');
            };
            that.changeToView = function(alertEntryModel) {
                that.alert = new AlertEntryModel(alertEntryModel.alert());

                that.activeTemplate('alert-entry-template');
            };
            that.changeToPreferences = function() {
                that.publisherSettings = new AlertPublisherTypeDefaultsModel(publisherTypes());
                that.marketDataSettings = new MarketDataConfigurationModel(marketDataConfiguration());

                that.activeTemplate('alert-preferences-template');
            };
            that.deleteAlert = function(alertDisplayModel) {
                alertDisplayModel.processing(true);

                alertManager.deleteAlert(alertDisplayModel.alert())
                    .then(function() {
                        that.alerts.remove(alertDisplayModel);
                    });
            };

            that.handleAlertChange = function(changedAlert) {
                var existingModel = getModel(changedAlert);

                if (existingModel) {
                    existingModel.alert(changedAlert);
                } else {
                    that.alerts.push(new AlertDisplayModel(changedAlert));

                    sortModels();
                }
            };
            that.handleAlertDelete = function(deletedAlert) {
                var modelToRemove = getModel(deletedAlert);

                that.alerts.remove(modelToRemove);
            };

            that.changeToGrid();
        }
        function AlertDisplayModel(alert) {
            var that = this;

            that.alert = ko.observable(alert);
            that.processing = ko.observable(false);

            that.lastTriggerDateDisplay = ko.computed(function() {
                var alert = that.alert();

                var returnRef;

                if (alert.last_trigger_date) {
                    var lastTriggerDate = new Date(parseInt(alert.last_trigger_date));

                    returnRef = lastTriggerDate.toString();
                } else {
                    returnRef = 'never';
                }

                return returnRef;
            });

            that.canStart = ko.computed(function() {
                var alert = that.alert();

                return alert.alert_state === 'Inactive' || alert.alert_state === 'Triggered' || alert.alert_state === 'Orphaned';
            });
            that.canPause = ko.computed(function() {
                var alert = that.alert();

                return alert.alert_state === 'Active';
            });
            that.canRefresh = ko.computed(function() {
                return !that.canStart() && !that.canPause();
            });

            that.start = function() {
                alertManager.enableAlert(that.alert())
                    .then(function(updatedAlert) {
                        that.alert(updatedAlert);
                    });
            };
            that.pause = function() {
                alertManager.disableAlert(that.alert())
                    .then(function(updatedAlert) {
                        that.alert(updatedAlert);
                    });
            };
            that.refresh = function() {
                alertManager.retrieveAlert(that.alert())
                    .then(function(refreshedAlert) {
                        that.alert(refreshedAlert);
                    });
            };
        }
        function AlertEntryModel(alert) {
            var that = this;

            that.alert = ko.observable(alert || null);
            that.alertType = ko.observable('none');
            that.alertBehavior = ko.observable('terminate');
            that.name = ko.observable(null);
            that.userNotes = ko.observable(null);
            that.createDate = ko.observable(null);
            that.conditions = ko.observableArray([]);
            that.publishers = ko.observableArray([]);
            that.schedules = ko.observableArray([]);
            that.processing = ko.observable(false);

            that.alertBehaviors = ko.observable([ 'terminate', 'schedule', 'automatic' ]);
            that.alertTypes = ko.observable([ 'none', 'news', 'price' ]);

            that.automaticReset = ko.computed(function() {
                return that.alertBehavior() === 'automatic';
            });

            that.showSchedules = ko.computed(function() {
                return that.alertBehavior() === 'schedule';
            });

            that.clearAlert = function() {
                that.alert(null);
                that.alertType('none');
                that.alertBehavior('terminate');
                that.name(null);
                that.userNotes(null);
                that.createDate(null);
                that.conditions([]);
                that.publishers([]);
                that.schedules([]);
                that.processing(false);
            };
            that.createAlert = function() {
                that.processing(true);

                var alertType = that.alertType();

                if (alertType === 'none') {
                    alertType = null;
                }

                var alertBehavior = that.alertBehavior();

                if (alertType === 'news' && alertBehavior === 'automatic') {
                    alertBehavior = null;
                }

                if (alertBehavior === 'automatic') {
                    alertBehavior = 'terminate';
                }

                var schedules;

                if (alertBehavior === 'schedule') {
                    schedules = _.map(that.schedules(), function(schedule) {
                        return {
                            time: schedule.time(),
                            day: schedule.day(),
                            timezone: schedule.timezone()
                        };
                    });
                } else {
                    schedules = [ ];
                }

                var alert = {
                    name: that.name(),
                    alert_type: alertType,
                    user_notes: that.userNotes() || null,
                    user_id: userId,
                    alert_system: system,
                    automatic_reset: that.automaticReset(),
                    conditions: _.map(that.conditions(), function(condition) {
                        var property = condition.property();
                        var operator = condition.operator();
                        var operand = condition.operand();

                        if (operator.operand_type === 'Array' && _.isString(operand)) {
                            operand = _.map(operand.split(','), function(item) {
                                return _.trim(item);
                            });
                        }

                        if (property.type === 'percent') {
                            operand = parseFloat(operand) / 100;
                            operand = operand.toString();
                        }

                        var conditionData = {
                            property: {
                                property_id: property.property_id,
                                target: {
                                    identifier: condition.targetIdentifier()
                                }
                            },
                            operator: {
                                operator_id: operator.operator_id,
                                operand: operand
                            }
                        };

                        var qualifiers = condition.qualifiers();

                        if (qualifiers.length > 0) {
                            conditionData.property.target.qualifiers = _.map(qualifiers, function(qualifier) {
                                 return qualifier.qualifierValue();
                            });
                        }

                        return conditionData;
                    }),
                    publishers: _.map(that.publishers(), function(publisher) {
                        return {
                            type: {
                                publisher_type_id: publisher.publisherType().publisher_type_id
                            },
							use_default_recipient: publisher.useDefaultRecipient(),
                            recipient: publisher.recipient(),
                            format: publisher.format()
                        };
                    }),
                    schedules: schedules
                };

                if (alertBehavior !== null) {
                    alert.alert_behavior = alertBehavior;
                }

                alertManager.createAlert(alert)
                    .then(function(created) {
                        that.alert(created);
                    })
                    .finally(function() {
                        that.processing(false);
                    });
            };

            that.selectAlertType = function(alertType) {
                that.alertType(alertType);
            };
            that.selectAlertBehavior = function(alertBehavior) {
                that.alertBehavior(alertBehavior);
            };
            that.addCondition = function(conditionToAdd) {
                that.conditions.push(new AlertConditionModel(that.ready, conditionToAdd || null));
            };
            that.removeCondition = function(conditionToRemove) {
                that.conditions.remove(conditionToRemove);
            };
            that.addPublisher = function(publisherToAdd) {
                that.publishers.push(new AlertPublisherModel(that.ready, publisherToAdd || null));
            };
            that.removePublisher = function(publisherToRemove) {
                that.publishers.remove(publisherToRemove);
            };
            that.addSchedule = function(scheduleToAdd) {
                that.schedules.push(new AlertScheduleModel(that.ready, scheduleToAdd || null));
            };
            that.removeSchedule = function(scheduleToRemove) {
                that.schedules.remove(scheduleToRemove);
            };

            that.complete = ko.computed(function() {
                return _.isObject(that.alert());
            });
            that.ready = ko.computed(function() {
                return !that.complete() && !that.processing();
            });
            that.canSave = ko.computed(function() {
                return that.ready() && _.isString(that.name()) && that.name().length > 0;
            });

            if (_.isObject(alert)) {
                that.name(alert.name);

                var alertBehavior = alert.alert_behavior || terminate;

                if (alertBehavior === 'terminate' && alert.automatic_reset) {
                    alertBehavior = 'automatic';
                }

                that.alertBehavior(alertBehavior);

                if (_.isString(alert.user_notes)) {
                    that.userNotes(alert.user_notes);
                }

                that.alertType(alert.alert_type || 'none');

                that.createDate(new Date(parseInt(alert.create_date)));

                _.forEach(alert.conditions, function(condition) {
                    that.addCondition(condition);
                });
                _.forEach(alert.publishers, function(publisher) {
                    that.addPublisher(publisher);
                });
                _.forEach(alert.schedules, function(schedule) {
                    that.addSchedule(schedule);
                });
            }
        }
        function AlertScheduleModel(ready, schedule) {
            var that = this;

            that.time = ko.observable(null);

            that.day = ko.observable('Monday');
            that.days = ko.observable(['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']);

            that.timezones = ko.observable(Barchart.Alerts.timezone.getTimezones());
            that.timezone = ko.observable(Barchart.Alerts.timezone.guessTimezone());

            that.selectDay = function(day) {
                that.day(day);
            };
            that.selectTimezone = function(timezone) {
                that.timezone(timezone);
            };

            that.ready = ready;

            if (_.isObject(schedule)) {
                that.time(schedule.time);
                that.day(schedule.day);
                that.timezone(schedule.timezone);
            }
        }
        function AlertConditionModel(ready, condition) {
            var that = this;

            that.target = ko.observable(null);
            that.targetIdentifier = ko.observable(null);

            that.properties = ko.observableArray([]);
            that.property = ko.observable(null);

            that.operator = ko.observable(null);
            that.operand = ko.observable(null);

            that.ready = ready;

            that.targets = ko.computed(function() {
                return targets();
            });
            that.operators = ko.computed(function() {
                var p = that.property();
                var o = operators() || [ ];

                var returnRef;

                if (p) {
                    returnRef = utilities.getOperatorsForProperty(o, p);
                } else {
                    returnRef = [ ];
                }

                that.operator(_.first(returnRef) || null);

                return returnRef;
            });
            that.qualifiers = ko.computed(function() {
                var target = that.target();

                var returnRef;

                if (target) {
                    return _.map(target.qualifier_descriptions || [], function (description, index) {
                        var value;

                        if (_.isObject(condition) && _.isArray(condition.property.target.qualifiers)) {
                            value = condition.property.target.qualifiers[index];
                        } else {
                            value = null;
                        }

                        return new AlertTargetQualifierModel(ready, description, value);
                    });
                } else {
                    returnRef = [ ];
                }

                return returnRef;
            });
            that.propertyTree = ko.computed(function() {
                var target = that.target();

                var targetProperties;

                if (target) {
                    targetProperties = utilities.getPropertiesForTarget(properties(), that.target());
                } else {
                    targetProperties = [ ];
                }

                return utilities.getPropertyTree(targetProperties);
            });

            that.selectTarget = function(target) {
                that.target(target);

                that.properties([]);
                that.properties.push(new AlertConditionTreeModel(that, that.propertyTree(), 'Category', 0));

                that.property(null);
                that.operator(null);
            };
            that.selectPropertyTree = function(tree, index) {
                if (tree.items) {
                    var next = index + 1;

                    that.properties.splice(next);
                    that.properties.push(new AlertConditionTreeModel(that, tree.items, 'Property', next));

                    that.property(null);
                    that.operand(null);
                } else {
                    that.property(tree.item);
                    that.operand(_.first(that.operator().operand_options) || null);
                }
            };
            that.selectOperator = function(opertator) {
                that.operator(opertator);
                that.operand(_.first(that.operator().operand_options) || null);
            };
            that.selectOperand = function(operand) {
                that.operand(operand);
            };

            if (_.isObject(condition)) {
                that.target(_.find(targets(), function(target) {
                    return target.target_id === condition.property.target.target_id;
                }));
                that.property(_.find(properties(), function(property) {
                    return property.property_id === condition.property.property_id;
                }));
                that.operator(_.find(operators(), function(operator) {
                    return operator.operator_id === condition.operator.operator_id;
                }));

                that.targetIdentifier(condition.property.target.identifier);

                var operand = condition.operator.operand;

                if (_.isArray(operand)) {
                    operand = operand.join(',');
                }

                var p = that.property();

                if (p && p.type === 'percent') {
                    operand = parseFloat(operand) * 100;
                }

                that.operand(operand);

                var getNode = function(items, description) {
                    return _.find(items, function(item) {
                        return item.description === description;
                    });
                };

                var node = getNode(that.propertyTree(), condition.property.group);
                var descriptionPath = ([ ]).concat(condition.property.category || [ ]).concat(condition.property.description);

                for (var i = 0; i < descriptionPath.length; i++) {
                    var n = getNode(node.items, descriptionPath[i]);

                    that.properties.push(new AlertConditionTreeModel(that, node.items, 'Property', i, n));

                    node = n;
                }
            } else {
                that.selectTarget(_.first(that.targets()));
            }
        }
        function AlertTargetQualifierModel(ready, description, value) {
            var that = this;

            that.ready = ready;

            that.qualifierDescription = ko.observable(description);
            that.qualifierValue = ko.observable(value || null);
        }
        function AlertConditionTreeModel(parent, tree, description, index, node) {
            var that = this;

            that.parent = parent;

            that.tree = ko.observable(tree);
            that.node = ko.observable(node || null);

            that.description = ko.computed(function() {
                var property = that.node();

                var returnRef;

                if (property) {
                    returnRef = property.description;
                } else {
                    returnRef = 'Select ' + description;
                }

                return returnRef;
            });

            that.selectTree = function(node) {
                that.node(node);

                that.parent.selectPropertyTree(node, index);
            };

            that.showOperator = ko.computed(function() {
                var node = that.node();

                var property = that.parent.property();
                var operator = that.parent.operator();

                return _.isObject(node) && _.isObject(node.item) && node.item === property && _.isObject(operator) && operator.operator_type === 'binary';
            });
            that.showOptions = ko.computed(function() {
                var operator = that.parent.operator();

                return _.isObject(operator) && _.isArray(operator.operand_options) && operator.operand_options.length > 0;
            });
            that.showPercent = ko.computed(function() {
                var property = that.parent.property();

                return property !== null && property.type === 'percent';
            });
        }
        function AlertPublisherModel(ready, publisher) {
            var that = this;

            that.publisherTypes = publisherTypes;
            that.publisherType = ko.observable(_.first(that.publisherTypes()));
            that.useDefaultRecipient = ko.observable(false);
            that.recipient = ko.observable();
            that.format = ko.observable();

            that.ready = ready;

            that.selectPublisherType = function(publisherType) {
                that.publisherType(publisherType);
            };

            that.toggleDefaultRecipient = function() {
				if (!ready() || !_.isString(that.publisherType().default_recipient)) {
					return;
				}

                that.useDefaultRecipient(!that.useDefaultRecipient());

                if (that.useDefaultRecipient()) {
                    that.recipient(that.publisherType().default_recipient);
                } else {
                    that.recipient('');
                }
            };

            that.recipientReady = ko.computed(function() {
                var ready = that.ready();
                var useDefaultRecipient = that.useDefaultRecipient();

                return ready && !useDefaultRecipient;
            });

            if (_.isObject(publisher)) {
                that.publisherType(_.find(publisherTypes(), function(candidate) {
                    return candidate.publisher_type_id === publisher.type.publisher_type_id;
                }));

                that.useDefaultRecipient(publisher.use_default_recipient);
                that.recipient(publisher.recipient);
                that.format(publisher.format);
            }
        }
        function AlertPublisherTypeDefaultsModel(publisherTypeDefaults) {
            var that = this;

            that.processing = ko.observable(false);

            that.ready = ko.computed(function() {
                return !that.processing();
            });

            that.publisherTypeDefaults = ko.observable(_.map(publisherTypeDefaults, function(publisherTypeDefault) {
               return new AlertPublisherTypeDefaultModel(publisherTypeDefault, that.ready);
            }));

            that.savePreferences = function() {
                var defaultPublisherTypes = that.publisherTypeDefaults();
                var publishersToSave = defaultPublisherTypes.length;

                var checkComplete = function() {
                    publishersToSave = publishersToSave - 1;

                    if (publishersToSave === 0) {
						alertManager.getPublisherTypeDefaults({ user_id: userId, alert_system: system })
							.then(function(pt) {
								publisherTypes(pt);

								that.processing(false);
							});
                    }
                };

                if (publishersToSave.length !== 0) {
                    that.processing(true);

                    _.forEach(defaultPublisherTypes, function(defaultPublisherType) {
                        if (_.isString(defaultPublisherType.defaultRecipient())) {
                            var activeAlertTypes = [ ];

                            if (defaultPublisherType.priceActive()) {
                                activeAlertTypes.push('price');
                            }

                            if (defaultPublisherType.newsActive()) {
                                activeAlertTypes.push('news');
                            }

                            var ptd = {
                                publisher_type_id: defaultPublisherType.publisherTypeId(),
                                alert_system: system,
                                user_id: userId,
                                default_recipient: defaultPublisherType.defaultRecipient(),
                                allow_window_timezone: defaultPublisherType.allowTimezone() || null,
                                allow_window_start: defaultPublisherType.allowStartTime() || null,
                                allow_window_end: defaultPublisherType.allowEndTime() || null,
                                active_alert_types: activeAlertTypes
                            };

                            var hmac = defaultPublisherType.defaultRecipientHmac();

                            if (_.isString(hmac) && hmac.length > 0) {
                                ptd.default_recipient_hmac = hmac;
                            }

                            alertManager.assignPublisherTypeDefault(ptd)
                                .then(function(savedPublisherTypeDefault) {
                                    checkComplete();
                                });
                        } else {
                            checkComplete();
                        }
                    });
                }
            };
        }
        function AlertPublisherTypeDefaultModel(publisherTypeDefault, ready) {
            var that = this;

            that.ready = ready;

            that.timezones = ko.observable(Barchart.Alerts.timezone.getTimezones());

            that.publisherTypeId = ko.observable(publisherTypeDefault.publisher_type_id)
            that.transport = ko.observable(publisherTypeDefault.transport);
            that.provider = ko.observable(publisherTypeDefault.provider);
            that.defaultRecipient = ko.observable(publisherTypeDefault.default_recipient);
            that.defaultRecipientHmac = ko.observable(publisherTypeDefault.default_recipient_hmac);
            that.allowTimezone = ko.observable(publisherTypeDefault.allow_window_timezone || Barchart.Alerts.timezone.guessTimezone());
            that.allowStartTime = ko.observable(publisherTypeDefault.allow_window_start);
            that.allowEndTime = ko.observable(publisherTypeDefault.allow_window_end);
            that.priceActive = ko.observable(_.includes(publisherTypeDefault.active_alert_types, 'price'));
            that.newsActive = ko.observable(_.includes(publisherTypeDefault.active_alert_types, 'news'));

            that.selectTimezone = function(timezone) {
                that.allowTimezone(timezone);
            };
        }
        function MarketDataConfigurationModel(mdc) {
            var that = this;

            that.processing = ko.observable(false);

            that.ready = ko.computed(function() {
                return !that.processing();
            });

            that.userId = ko.observable(userId);
            that.systemId = ko.observable(system);
            that.marketDataId = ko.observable(null);

            that.savePreferences = function() {
                that.processing(true);

                alertManager.assignMarketDataConfiguration({ user_id: userId, alert_system: system, market_data_id: that.marketDataId() })
                    .then(function(mdc) {
                        marketDataConfiguration(mdc);

                        that.processing(false);
                    });
            };

            if (mdc && mdc.market_data_id) {
                that.marketDataId(mdc.market_data_id);
            }
        }

        $(document).ready(function() {
            alertManager.connect()
                .then(function() {
                    var pageModel = new PageModel();

                    alertManager.subscribeAlerts({ user_id: userId, alert_system: system },
                        function(changedAlert) {
                            pageModel.handleAlertChange(changedAlert);
                        },
                        function(deletedAlert) {
                            pageModel.handleAlertDelete(deletedAlert);
                        }
                    );

                    alertManager.getServerVersion()
                        .then(function(version) {
                            pageModel.version({ api: version.semver, client: Barchart.Alerts.version });
                        });

                    alertManager.getTargets()
                        .then(function(t) {
                            targets(t);
                        });

                    alertManager.getProperties()
                        .then(function(p) {
                            properties(p);
                        });

                    alertManager.getOperators()
                        .then(function(o) {
                            operators(o);
                        });

                    alertManager.getPublisherTypeDefaults({ user_id: userId, alert_system: system })
                        .then(function(pt) {
                            publisherTypes(pt);
                        });

                    alertManager.getMarketDataConfiguration({ user_id: userId, alert_system: system })
                        .then(function(mdc) {
                            marketDataConfiguration(mdc);
                        });

                    ko.applyBindings(pageModel, $('body')[0]);
                });
        });
    </script>

    <script type="text/html" id="alert-header-template">
        <div class="pull-left">
            <h4 class="pull-left">Barchart Alert API</h4>

            <div class="header-action-buttons pull-right">
                <span class="text-button glyphicon glyphicon-th-list" data-bind="click: changeToGrid"></span>
                <span class="text-button glyphicon glyphicon-plus" data-bind="click: changeToCreate"></span>
                <span class="text-button glyphicon glyphicon-user" data-bind="click: changeToPreferences"></span>
            </div>
        </div>
    </script>

    <script type="text/html" id="alert-grid-template">
        <table class="table table-striped small">
            <thead>
                <th class="center col-md-1"></th>
                <th class="left col-md-3">ID</th>
                <th class="left col-md-2">Name</th>
                <th class="center col-md-2">State</th>
                <th class="center col-md-1">Conditions</th>
                <th class="center col-md-1">Publishers</th>
                <th class="center col-md-2">Last Triggered</th>
            </thead>
            <tbody data-bind="template: { name: 'alert-grid-item-template', foreach: alerts }"></tbody>
        </table>
    </script>

    <script type="text/html" id="alert-grid-item-template">
        <tr>
            <td class="center col-md-1 alert-action-buttons">
                <span class="text-button text-button-black glyphicon glyphicon-search" data-bind="click: function() { $parent.changeToView($data); }"></span>
                <span class="text-button text-button-black glyphicon glyphicon-remove" data-bind="click: function() { $parent.deleteAlert($data); }, visible: !processing()"></span>
            </td>
            <td class="left col-md-3" data-bind="text: alert().alert_id"></td>
            <td class="left col-md-2" data-bind="text: alert().name"></td>
            <td class="center col-md-2">
                <div>
                <span class="alert-state-buttons">
                    <span class="text-button text-button-black glyphicon glyphicon-play" data-bind="click: start, visible: canStart"></span>
                    <span class="text-button text-button-black glyphicon glyphicon-pause" data-bind="click: pause, visible: canPause"></span>
                    <span class="text-button text-button-black glyphicon glyphicon-refresh" data-bind="click: refresh, visible: canRefresh"></span>
                </span>
                <span data-bind="text: alert().alert_state"></span>
                </div>
            </td>
            <td class="center col-md-1" data-bind="text: alert().conditions.length"></td>
            <td class="center col-md-1" data-bind="text: alert().publishers.length"></td>
            <td class="center col-md-2" data-bind="text: lastTriggerDateDisplay"></td>
        </tr>
    </script>

    <script type="text/html" id="alert-entry-template">
        <div data-bind="with: alert">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">General</h3>
                </div>
                <table class="alert-create table">
                    <tbody>
                        <tr>
                            <td class="col-md-1">
                                <label class="control-label col-md-1">Name</label>
                            </td>
                            <td class="col-md-5">
                                <input class="form-control" data-bind="textInput: name, enable: ready" type="text" placeholder="Alert Name">
                            </td>
                            <td class="col-md-2">
                                <label class="control-label">Trigger Behavior</label>
                            </td>
                            <td class="col-md-2">
                                <div class="dropdown">
                                    <button class="btn btn-default dropdown-toggle" data-bind="enable: ready" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        <span data-bind="text: alertBehavior"></span>
                                    </button>
                                    <ul class="dropdown-menu" data-bind="foreach: alertBehaviors">
                                        <li class="center"><a href="#" data-bind="text: $data, click: function() { $parent.selectAlertBehavior($data); }"></a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="col-md-1">
                                <label class="control-label col-md-1">Notes</label>
                            </td>
                            <td class="col-md-5">
                                <input class="form-control" data-bind="textInput: userNotes, enable: ready" type="text" placeholder="User Notes">
                            </td>
                            <td class="col-md-2">
                                <label class="control-label">Classification</label>
                            </td>
                            <td class="col-md-2">
                                <div class="dropdown">
                                    <button class="btn btn-default dropdown-toggle" data-bind="enable: ready" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        <span data-bind="text: alertType"></span>
                                    </button>
                                    <ul class="dropdown-menu" data-bind="foreach: alertTypes">
                                        <li class="center"><a href="#" data-bind="text: $data, click: function() { $parent.selectAlertType($data); }"></a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <tr data-bind="visible: createDate">
                            <td class="col-md-1">
                                <label class="control-label col-md-1">Created</label>
                            </td>
                            <td class="col-md-9" colspan="3" data-bind="text: createDate"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="text-button entry-item-add-button glyphicon glyphicon-plus" data-bind="click: function() { addCondition(null); }, visible: ready"></span> Conditions</h3>
                </div>
                <table class="alert-create table">
                    <!-- ko foreach: conditions -->
                    <tbody data-bind="template: { name: 'alert-create-condition-template' }"></tbody>
                    <!-- /ko -->
                </table>
            </div>
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="text-button entry-item-add-button glyphicon glyphicon-plus" data-bind="click: function() { addPublisher(null); }, visible: ready"></span> Publishers</h3>
                </div>
                <table class="alert-create table">
                    <tbody class="table" data-bind="template: { name: 'alert-create-publisher-template', foreach: publishers }"></tbody>
                </table>
            </div>
            <!-- ko if: showSchedules -->
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="text-button entry-item-add-button glyphicon glyphicon-plus" data-bind="click: function() { addSchedule(null); }, visible: ready"></span> Schedules</h3>
                </div>
                <table class="alert-create table">
                    <!-- ko foreach: schedules -->
                    <tbody data-bind="template: { name: 'alert-create-schedule-template' }"></tbody>
                    <!-- /ko -->
                </table>
            </div>
            <!-- /ko -->
            <button class="btn btn-primary btn-default" data-bind="click: createAlert, enable: canSave">Save</button>
            <button class="btn btn-primary btn-default" data-bind="click: clearAlert, visible: complete">New</button>
        </div>
    </script>

    <script type="text/html" id="alert-create-schedule-template">
        <tr>
            <td class="col-md-1">
                <span class="text-button text-button-black glyphicon glyphicon-minus entry-item-remove-button" data-bind="click: function() { $parent.removeSchedule($data); }, visible: ready"></span>
            </td>
            <td class="col-md-2">
                <input class="form-control" data-bind="textInput: time, enable: ready" type="text" placeholder="HH:MM">
            </td>
            <td class="col-md-3">
                <div class="dropdown">
                    <button class="btn btn-default dropdown-toggle" data-bind="enable: ready" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <span data-bind="text: day"></span>
                    </button>
                    <ul class="dropdown-menu" data-bind="foreach: days">
                        <li class="center"><a href="#" data-bind="text: $data, click: function() { $parent.selectDay($data); }"></a></li>
                    </ul>
                </div>
            </td>
            <td class="col-md-4" colspan="2">
                <div class="dropdown">
                    <button class="btn btn-default dropdown-toggle" data-bind="enable: ready" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <span data-bind="text: timezone"></span>
                    </button>
                    <ul class="dropdown-menu" data-bind="foreach: timezones">
                        <li class="center"><a href="#" data-bind="text: $data, click: function() { $parent.selectTimezone($data); }"></a></li>
                    </ul>
                </div>
            </td>
        </tr>
    </script>

    <script type="text/html" id="alert-create-condition-template">
        <tr class="condition">
            <td class="col-md-1">
                <span class="text-button text-button-black glyphicon glyphicon-minus entry-item-remove-button" data-bind="click: function() { $parent.removeCondition($data); }, visible: ready"></span>
            </td>
            <td class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-default dropdown-toggle" data-bind="enable: ready" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <span data-bind="text: target().description"></span>
                    </button>
                    <ul class="dropdown-menu" data-bind="foreach: targets">
                        <li class="center"><a href="#" data-bind="text: description, click: function() { $parent.selectTarget($data); }"></a></li>
                    </ul>
                </div>
            </td>
            <td class="col-md-3">
                <input class="form-control" data-bind="textInput: targetIdentifier, attr: { placeholder: target().identifier_description }, enable: ready" type="text">
            </td>
            <td class="col-md-4" colspan="2">
            </td>
        </tr>
        <!-- ko foreach: qualifiers -->
        <tr class="qualifier" data-bind="template: { name: 'alert-create-condition-qualifier-template' }"></tr>
        <!-- /ko -->
        <!-- ko foreach: properties -->
        <tr class="component" data-bind="template: { name: 'alert-create-condition-property-template' }"></tr>
        <!-- /ko -->
    </script>

    <script type="text/html" id="alert-create-condition-qualifier-template">
        <td class="col-md-1"></td>
        <td class="col-md-2"></td>
        <td class="col-md-3">
            <input class="form-control" data-bind="textInput: qualifierValue, enable: ready, attr: { placeholder: qualifierDescription }" type="text">
        </td>
        <td class="col-md-4" colspan="2">
        </td>
    </script>

    <script type="text/html" id="alert-create-condition-property-template">
        <td class="col-md-1"></td>
        <td class="col-md-2"></td>
        <td class="col-md-3">
            <div class="dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" data-bind="enable: parent.ready" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    <span data-bind="text: description"></span>
                </button>
                <ul class="dropdown-menu" data-bind="foreach: tree">
                    <li class="center"><a href="#" data-bind="text: description, click: function() { $parent.selectTree($data); }"></a></li>
                </ul>
            </div>
        </td>
        <!-- ko if: showOperator -->
        <td class="col-md-2">
            <div class="dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" data-bind="enable: parent.ready" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    <span data-bind="text: parent.operator().display.short"></span>
                </button>
                <ul class="dropdown-menu" data-bind="foreach: parent.operators">
                    <li class="center"><a href="#" data-bind="text: display.short, click: function() { $parent.parent.selectOperator($data); }"></a></li>
                </ul>
            </div>
        </td>
        <!-- ko if: showOptions -->
        <td class="col-md-2">
            <div class="dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" data-bind="enable: parent.ready" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    <span data-bind="text: parent.operand()"></span>
                </button>
                <ul class="dropdown-menu" data-bind="foreach: parent.operator().operand_options">
                    <li class="center"><a href="#" data-bind="text: $data, click: function() { $parent.parent.selectOperand($data); }"></a></li>
                </ul>
            </div>
        </td>
        <!-- /ko -->
        <!-- ko ifnot: showOptions -->
        <td class="col-md-2">
            <input class="form-control pull-left" data-bind="css: { percent: showPercent }, textInput: parent.operand, enable: parent.ready" type="text" placeholder="value">
            <!-- ko if: showPercent -->
            <div class="pull-right">%</div>
            <!-- /ko -->
        </td>
        <!-- /ko -->
        <!-- /ko -->
        <!-- ko ifnot: showOperator -->
        <td class="col-md-4" colspan="2">
        </td>
        <!-- /ko -->
    </script>

    <script type="text/html" id="alert-create-publisher-template">
        <tr>
            <td class="col-md-1">
                <span class="text-button text-button-black glyphicon glyphicon-minus entry-item-remove-button" data-bind="click: function() { $parent.removePublisher($data); }, visible: ready"></span>
            </td>
            <td class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-default dropdown-toggle" data-bind="enable: ready" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <span data-bind="text: publisherType().transport"></span>
                    </button>
                    <ul class="dropdown-menu" data-bind="foreach: publisherTypes">
                        <li class="center"><a href="#" data-bind="text: transport, click: function() { $parent.selectPublisherType($data); }"></a></li>
                    </ul>
                </div>
            </td>
            <td class="col-md-3">
                <div class="input-group">
                    <div class="input-group-addon">
                        <div class="text-button" data-bind="click: toggleDefaultRecipient, enable: ready">
                            <!-- ko if: useDefaultRecipient -->
                            <span>Default</span>
                            <!-- /ko -->
                            <!-- ko ifnot: useDefaultRecipient -->
                            <span>Custom</span>
                            <!-- /ko -->
                        </div>
                    </div>
                    <input class="form-control" data-bind="textInput: recipient, enable: recipientReady" type="text" placeholder="Recipient (e.g. phone number)">
                </div>
            </td>
            <td class="col-md-4">
                <input class="form-control" data-bind="textInput: format, enable: ready" type="text" placeholder="Message (to include with alert)">
            </td>
        </tr>
    </script>

    <script type="text/html" id="alert-preferences-template">
        <div data-bind="with: marketDataSettings" style="margin-bottom: 20px;">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">Market Data Settings</h3>
                </div>

                <table class="market-data-settings table">
                    <tbody>
                    <tr>
                        <td class="col-md-2">
                            <label class="control-label">System</label>
                        </td>
                        <td class="col-md-4">
                            <input class="form-control" data-bind="textInput: system, enable: false" type="text" placeholder="System Name">
                        </td>
                        <td class="col-md-2">
                            <label class="control-label">User ID</label>
                        </td>
                        <td class="col-md-4">
                            <input class="form-control" data-bind="textInput: userId, enable: false" type="text" placeholder="User ID">
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-2">
                            <label class="control-label">Market Data ID</label>
                        </td>
                        <td class="col-md-4">
                            <input class="form-control" data-bind="textInput: marketDataId, enable: ready" type="text" placeholder="Market Data ID">
                        </td>
                        <td class="col-md-2">
                        </td>
                        <td class="col-md-4">
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div>
                <button class="btn btn-primary btn-default" data-bind="click: savePreferences, enable: ready">Save</button>
            </div>
        </div>

        <div data-bind="with: publisherSettings">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">Publisher Settings</h3>
                </div>

                <table class="table table-striped small" style="margin-bottom: 5px;">
                    <thead>
                        <th class="left col-md-1">Transport</th>
                        <th class="center col-md-2">Default Recipient</th>
                        <th class="center col-md-2">Default Recipient HMAC</th>
                        <th class="center col-md-2">Timezone</th>
                        <th class="center col-md-1">Start Time</th>
                        <th class="center col-md-1">End Time</th>
                        <th class="center col-md-1">Price Alerts</th>
                        <th class="center col-md-1">News Alerts</th>
                    </thead>
                    <tbody data-bind="template: { name: 'publisher-type-preference-template', foreach: publisherTypeDefaults }"></tbody>
                </table>
            </div>

            <div>
                <button class="btn btn-primary btn-default" data-bind="click: savePreferences, enable: ready">Save</button>
            </div>
        </div>
    </script>

    <script type="text/html" id="publisher-type-preference-template">
        <tr>
            <td class="left col-md-1">
                <span><span data-bind="text: transport"></span> (<span data-bind="text: provider"></span>)</span>
            </td>
            <td class="left col-md-2">
                <input class="form-control" data-bind="textInput: defaultRecipient, enable: ready" type="text" placeholder="Recipient (e.g. phone number)">
            </td>
            <td class="left col-md-2">
                <input class="form-control" data-bind="textInput: defaultRecipientHmac, enable: ready" type="text" placeholder="HMAC">
            </td>
            <td class="left col-md-2">
                <div class="dropdown">
                    <button class="btn btn-default dropdown-toggle" data-bind="enable: ready" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <span data-bind="text: allowTimezone"></span>
                    </button>
                    <ul class="dropdown-menu" data-bind="foreach: timezones">
                        <li class="center"><a href="#" data-bind="text: $data, click: function() { $parent.selectTimezone($data); }"></a></li>
                    </ul>
                </div>
            </td>
            <td class="left col-md-1">
                <input class="form-control" data-bind="textInput: allowStartTime, enable: ready" type="text" placeholder="HH:MM">
            </td>
            <td class="left col-md-1">
                <input class="form-control" data-bind="textInput: allowEndTime, enable: ready" type="text" placeholder="HH:MM">
            </td>
            <td class="center col-md-1">
                <input type="checkbox" data-bind="checked: priceActive, enable: ready">
            </td>
            <td class="center col-md-1">
                <input type="checkbox" data-bind="checked: newsActive, enable: ready">
            </td>
        </tr>
    </script>
</head>
<body>
    <div class="header" data-bind="template: { name: 'alert-header-template' }"></div>
    <div class="main" data-bind="template: { name: activeTemplate }"></div>
    <div class="footer">
        <h4 class="pull-left" data-bind="text: providerDescription"></h4>
        <h4 class="pull-right">API Version <span data-bind="text: version().api"></span>, Client Version: <span data-bind="text: version().client"></span></h4>
    </div>
</body>
</html>